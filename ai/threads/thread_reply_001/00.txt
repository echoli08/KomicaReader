# KomicaReader 回文功能失效分析報告 (V4.0)

**分析日期:** 2026-01-08  
**日誌檔案:** `W:\KomicaReader\ai\threads\thread_reply_001\99.txt`  
**程式碼版本:** TurnstileDialog.java V4.0  
**問題狀態:** 回文功能仍然失效

---

## 一、日誌分析摘要

### 1.1 99.txt 日誌觀察

| 時間戳 | 事件 | 狀態 |
|--------|------|------|
| 08:31:03.x | 觸控事件 (回覆按鈕) | ✅ 正常 |
| 08:31:03.x | PopupWindow 開啟 | ✅ 正常 |
| 08:31:03.x | WebView 相關日誌 | ❌ **未出現** |

### 1.2 缺失的關鍵日誌

```
KLog.d("WebView finish: ...")       // 未出現
KLog.d("V4.0 State: ...")          // 未出現
KLog.d("WebView Console: ...")     // 未出現
KLog.e("WebView Error: ...")       // 未出現
```

**結論:** 日誌檔案可能被截斷，或 WebView 在載入過程中發生問題。

---

## 二、程式碼問題診斷 (V4.0)

### 2.1 程式碼已改善的部分

| 功能 | 狀態 | 說明 |
|------|------|------|
| 頁面狀態檢測 | ✅ | CHALLENGE / FORM / SUCCESS / ERROR |
| Cloudflare iframe 檢測 | ✅ | `ifs[i].src.includes('cloudflare')` |
| Checkbox 文字檢測 | ✅ | `/驗證\|人\|human/i.test(pt)` |
| 表單選擇器 | ✅ | `querySelector('input[name=name]')` |

### 2.2 仍存在的致命問題

#### 問題 1: 未自動點擊 Checkbox (最關鍵)

**V4.0 程式碼 (L125-127):**
```java
if (state.equals("CHALLENGE")) {
    progressBar.setVisibility(View.GONE);
    injectCleanUpCss(); 
    // ❌ 問題：只隱藏元素，完全沒有點擊 checkbox！
}
```

**後果:**
- 使用者必須手動勾選驗證 checkbox
- 如果使用者未看到或未勾選，流程永遠卡住
- 沒有任何提示告知使用者需要手動操作

#### 問題 2: 無監控迴圈

**當前流程:**
```
檢測 Challenge → 隱藏載入中 → 停止
```

**正確流程:**
```
檢測 Challenge → 自動點擊 → 監控狀態 → 
驗證完成 → 填寫表單 → 提交 → 成功
```

#### 問題 3: 無超時處理

- 沒有最大等待時間
- 沒有重試機制
- 使用者可能永遠等待

#### 問題 4: ERROR 狀態未回調

**V4.0 程式碼 (L132-133):**
```java
} else if (state.startsWith("ERROR")) {
    KLog.e("Post failed: " + state);
    // ❌ 問題：只記錄日誌，未呼叫 callback.onError()
}
```

---

## 三、完整修復方案

### 3.1 修復版 TurnstileDialog.java

```java
package com.komica.reader.ui;

import android.app.Dialog;
import android.content.Context;
import android.os.Handler;
import android.os.Looper;
import android.view.LayoutInflater;
import android.view.View;
import android.webkit.ConsoleMessage;
import android.webkit.WebChromeClient;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.Button;
import android.widget.ProgressBar;
import android.widget.Toast;
import com.komica.reader.R;
import com.komica.reader.util.KLog;

public class TurnstileDialog extends Dialog {

    public interface Callback {
        void onSuccess();
        void onTokenReceived(String token);
        void onCancelled();
        void onError(String error);
    }

    private WebView webView;
    private ProgressBar progressBar;
    private Callback callback;
    private String formUrl;
    private boolean isFinished = false;
    private boolean isFirstLoad = true;
    private int checkCount = 0;
    
    private String name, email, subject, comment;
    private Handler handler = new Handler(Looper.getMainLooper());
    private static final int MAX_CHECK = 120; // 120 秒超時
    private static final int CHECK_INTERVAL = 1500; // 1.5 秒檢查一次

    public TurnstileDialog(Context context, String formUrl, 
                           String name, String email, String subject, String comment,
                           Callback callback) {
        super(context, android.R.style.Theme_Material_Light_Dialog_Alert);
        this.formUrl = formUrl;
        this.name = name;
        this.email = email;
        this.subject = subject;
        this.comment = comment;
        this.callback = callback;
        init();
    }

    public TurnstileDialog(Context context, String formUrl, Callback callback) {
        this(context, formUrl, "", "", "", "", callback);
    }

    private void init() {
        LayoutInflater inflater = LayoutInflater.from(getContext());
        View view = inflater.inflate(R.layout.dialog_turnstile_verification, null);
        webView = view.findViewById(R.id.turnstileWebView);
        progressBar = view.findViewById(R.id.progressBar);
        Button btnCancel = view.findViewById(R.id.btnCancel);
        btnCancel.setText("取消");

        WebSettings settings = webView.getSettings();
        settings.setJavaScriptEnabled(true);
        settings.setDomStorageEnabled(true);
        settings.setDatabaseEnabled(true);
        settings.setCacheMode(WebSettings.LOAD_DEFAULT);
        settings.setJavaScriptCanOpenWindowsAutomatically(true);
        settings.setUserAgentString("Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36");

        android.webkit.CookieManager cookieManager = android.webkit.CookieManager.getInstance();
        cookieManager.setAcceptCookie(true);
        cookieManager.setAcceptThirdPartyCookies(webView, true);

        webView.setWebChromeClient(new WebChromeClient() {
            @Override
            public boolean onConsoleMessage(ConsoleMessage cm) {
                KLog.d("WebView: " + cm.message());
                return true;
            }
            
            @Override
            public void onProgressChanged(WebView view, int progress) {
                if (progress % 25 == 0) {
                    KLog.d("WebView progress: " + progress + "%");
                }
            }
        });

        webView.setWebViewClient(new WebViewClient() {
            @Override
            public void onPageStarted(WebView view, String url, android.graphics.Bitmap favicon) {
                super.onPageStarted(view, url, favicon);
                KLog.d("WebView start: " + url);
            }

            @Override
            public void onPageFinished(WebView view, String url) {
                super.onPageFinished(view, url);
                KLog.d("WebView finish: " + url);
                if (isFinished) return;
                checkCount = 0;
                checkPageState();
            }

            @Override
            public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) {
                KLog.e("WebView Error " + errorCode + ": " + description);
                if (errorCode == ERROR_HOST_LOOKUP || errorCode == ERROR_CONNECT || errorCode == ERROR_TIMEOUT) {
                    handleError("網路連線失敗，請檢查網路後重試");
                }
            }
        });

        btnCancel.setOnClickListener(v -> cancelDialog());

        setContentView(view);
        setCancelable(false);
        setCanceledOnTouchOutside(false);

        java.util.Map<String, String> extraHeaders = new java.util.HashMap<>();
        extraHeaders.put("Referer", formUrl.split("pixmicat")[0]);
        
        KLog.d("Loading: " + formUrl);
        webView.loadUrl(formUrl, extraHeaders);
    }

    private void checkPageState() {
        if (isFinished) return;
        if (checkCount > MAX_CHECK) {
            KLog.e("Timeout after " + MAX_CHECK + " checks");
            handleError("載入超時，請檢查網路後重試");
            return;
        }

        String js = "(function() { " +
                "  var r = { s: 'UNKNOWN', t: null }; " +
                "  var txt = document.body.innerText || ''; " +
                "  if (txt.includes('文章送出') || txt.includes('回應送出')) { r.s = 'SUCCESS'; return JSON.stringify(r); } " +
                "  if (txt.includes('Spambot') || (txt.includes('錯誤') && txt.length < 200)) { r.s = 'ERROR'; r.t = txt.substring(0, 80); return JSON.stringify(r); } " +
                "  var ifs = document.querySelectorAll('iframe'); " +
                "  for(var i=0; i<ifs.length; i++) { if((ifs[i].src || '').includes('cloudflare')) { r.s = 'CHALLENGE'; r.t = 'iframe'; return JSON.stringify(r); } } " +
                "  var cbs = document.querySelectorAll('input[type=checkbox]'); " +
                "  for(var j=0; j<cbs.length; j++) { " +
                "    var pt = cbs[j].parentElement ? cbs[j].parentElement.innerText : ''; " +
                "    if(/驗證|人|human/i.test(pt)) { r.s = 'CHALLENGE'; r.t = 'checkbox'; return JSON.stringify(r); } " +
                "  } " +
                "  var f = document.querySelector('form[action*=pixmicat]'); " +
                "  if (f && (f.querySelector('textarea[name=com]') || f.querySelector('input[name=com]'))) { r.s = 'FORM'; return JSON.stringify(r); } " +
                "  return JSON.stringify(r); " +
                "})()";

        webView.evaluateJavascript(js, result -> {
            if (isFinished) return;
            
            try {
                KLog.d("Check #" + checkCount + ": " + result);
                checkCount++;
                
                org.json.JSONObject json = new org.json.JSONObject(result);
                String state = json.optString("s", "UNKNOWN");
                String type = json.optString("t", "");
                
                switch (state) {
                    case "SUCCESS":
                        handleSuccess();
                        break;
                    case "ERROR":
                        KLog.e("Post failed: " + type);
                        handleError("回覆失敗: " + (type.isEmpty() ? "請稍後再試" : type));
                        break;
                    case "CHALLENGE":
                        KLog.d("Challenge detected: " + type);
                        progressBar.setVisibility(View.GONE);
                        injectCleanUpCss();
                        if (!clickCloudflareCheckbox()) {
                            KLog.i("Auto-click failed, waiting for user");
                            Toast.makeText(getContext(), "請勾選下方驗證方塊", Toast.LENGTH_LONG).show();
                        }
                        startMonitoring();
                        break;
                    case "FORM":
                        injectReplyLogic();
                        break;
                    default:
                        handler.postDelayed(this::checkPageState, CHECK_INTERVAL);
                        break;
                }
            } catch (Exception e) {
                KLog.e("Parse error: " + e.getMessage());
                handler.postDelayed(this::checkPageState, CHECK_INTERVAL);
            }
        });
    }

    private boolean clickCloudflareCheckbox() {
        KLog.d("Attempting auto-click...");
        
        String js = "(function() { " +
                "  var r = { c: false, e: null }; " +
                "  var cbs = document.querySelectorAll('input[type=checkbox]'); " +
                "  for(var i=0; i<cbs.length; i++) { " +
                "    var p = cbs[i].parentElement; " +
                "    var pt = p ? p.innerText : ''; " +
                "    if(/驗證|人|human/i.test(pt)) { " +
                "      cbs[i].style.display = 'block'; " +
                "      if(!cbs[i].checked) { " +
                "        try { " +
                "          cbs[i].click(); " +
                "          cbs[i].checked = true; " +
                "          r.c = true; " +
                "        } catch(e) { r.e = e.message; } " +
                "      } else { r.c = true; } " +
                "      return JSON.stringify(r); " +
                "    } " +
                "  } " +
                "  r.e = 'not found'; " +
                "  return JSON.stringify(r); " +
                "})()";

        final boolean[] clicked = {false};
        webView.evaluateJavascript(js, result -> {
            try {
                KLog.d("Click result: " + result);
                org.json.JSONObject json = new org.json.JSONObject(result);
                if (json.optBoolean("c", false)) {
                    clicked[0] = true;
                    KLog.d("Checkbox clicked");
                }
            } catch (Exception e) {
                KLog.e("Click parse error: " + e.getMessage());
            }
        });
        return clicked[0];
    }

    private void startMonitoring() {
        handler.removeCallbacksAndMessages(null);
        handler.postDelayed(() -> {
            if (!isFinished) checkPageState();
        }, CHECK_INTERVAL);
    }

    private void injectCleanUpCss() {
        String js = "var s = document.createElement('style'); " +
                "s.innerHTML = '.post-head,.footer,.ad-container,#top-link,#bottom-link{display:none!important}#postform{display:block!important}'; " +
                "document.head.appendChild(s);";
        webView.evaluateJavascript(js, null);
    }

    private void injectReplyLogic() {
        if (comment == null || comment.isEmpty()) {
            handleError("回覆內容為空");
            return;
        }
        
        if (isFinished) return;
        KLog.d("Injecting reply...");
        
        String js = "(function() { " +
                "  var r = { f: false, s: false, e: null }; " +
                "  var f = document.querySelector('form[action*=pixmicat]'); " +
                "  if(!f) { r.e = 'form not found'; return JSON.stringify(r); } " +
                "  var ni = f.querySelector('input[name=name]'); if(ni) ni.value = '" + escapeJs(name) + "'; " +
                "  var ei = f.querySelector('input[name=email]'); if(ei) ei.value = '" + escapeJs(email) + "'; " +
                "  var si = f.querySelector('input[name=sub]'); if(si) si.value = '" + escapeJs(subject) + "'; " +
                "  var ci = f.querySelector('textarea[name=com]') || f.querySelector('input[name=com]'); " +
                "  if(ci) { ci.value = '" + escapeJs(comment) + "'; r.f = true; } " +
                "  else { r.e = 'comment field not found'; return JSON.stringify(r); } " +
                "  setTimeout(function() { " +
                "    var b = f.querySelector('input[type=submit]'); " +
                "    if(b) { b.click(); r.s = true; } " +
                "    else { f.submit(); r.s = true; } " +
                "  }, 500); " +
                "  return JSON.stringify(r); " +
                "})()";

        webView.evaluateJavascript(js, result -> {
            if (isFinished) return;
            
            try {
                KLog.d("Inject result: " + result);
                org.json.JSONObject json = new org.json.JSONObject(result);
                if (json.optBoolean("f", false)) {
                    handler.postDelayed(this::checkSubmissionResult, 2500);
                } else {
                    handleError("表單填寫失敗: " + json.optString("e", "未知錯誤"));
                }
            } catch (Exception e) {
                KLog.e("Inject parse error: " + e.getMessage());
                submitFormDirectly();
            }
        });
    }

    private void checkSubmissionResult() {
        if (isFinished) return;
        
        String url = webView.getUrl();
        KLog.d("Check result URL: " + url);
        
        if (url != null && url.contains("pixmicat.php?res=") && !url.contains("mode=regist")) {
            handleSuccess();
            return;
        }
        
        String js = "(function() { " +
                "  var txt = document.body.innerText || ''; " +
                "  if(txt.includes('文章送出') || txt.includes('回應送出')) return 'SUCCESS'; " +
                "  if(txt.includes('Spambot') || txt.includes('錯誤')) return 'ERROR'; " +
                "  return 'WAITING'; " +
                "})()";

        webView.evaluateJavascript(js, result -> {
            if (isFinished) return;
            
            result = result.replace("\"", "");
            if (result.equals("SUCCESS")) {
                handleSuccess();
            } else if (result.equals("ERROR")) {
                handleError("提交失敗，請稍後再試");
            } else {
                handler.postDelayed(this::checkSubmissionResult, 2000);
            }
        });
    }

    private void submitFormDirectly() {
        String js = "(function() { " +
                "  var f = document.querySelector('form[action*=pixmicat]'); " +
                "  if(f) { f.submit(); return 'SUBMITTED'; } " +
                "  return 'NOT_FOUND'; " +
                "})()";
        
        webView.evaluateJavascript(js, result -> {
            if (result != null && result.contains("SUBMITTED")) {
                handler.postDelayed(this::checkSubmissionResult, 2000);
            } else {
                handleError("提交失敗");
            }
        });
    }

    private void handleSuccess() {
        if (isFinished) return;
        isFinished = true;
        handler.removeCallbacksAndMessages(null);
        KLog.d("Reply SUCCESS!");
        if (callback != null) callback.onSuccess();
        dismiss();
    }

    private void handleError(String msg) {
        if (isFinished) return;
        isFinished = true;
        handler.removeCallbacksAndMessages(null);
        KLog.e("Error: " + msg);
        if (callback != null) callback.onError(msg);
        dismiss();
    }

    private void cancelDialog() {
        if (isFinished) return;
        isFinished = true;
        handler.removeCallbacksAndMessages(null);
        if (callback != null) callback.onCancelled();
        dismiss();
    }

    private String escapeJs(String text) {
        if (text == null) return "";
        char bs = (char)92;
        String bss = String.valueOf(bs);
        return text.replace(bss, bss + bss).replace("'", bss + "'")
                   .replace("\n", bss + "n").replace("\r", bss + "r");
    }

    @Override
    public void onDetachedFromWindow() {
        super.onDetachedFromWindow();
        cancelDialog();
    }
}
```

---

## 四、改進摘要對照表

| 功能 | V4.0 舊版 | 修復版 |
|------|-----------|--------|
| **自動點擊 checkbox** | ❌ 無 | ✅ 自動點擊 |
| **驗證完成監控** | ❌ 無 | ✅ Handler 監控 |
| **超時處理** | ❌ 無 | ✅ 120 秒超時 |
| **Toast 提示** | ❌ 無 | ✅ 提示使用者 |
| **ERROR callback** | ❌ 未呼叫 | ✅ 正確呼叫 |
| **進度顯示** | ❌ 無 | ✅ onProgressChanged |
| **詳細日誌** | ⚠️ 不足 | ✅ 每階段日誌 |

---

## 五、預期日誌流程

```
KLog.d("Loading: https://gaia.komica1.org/79/pixmicat.php?res=30464288")
KLog.d("WebView start: https://gaia.komica1.org/79/pixmicat.php?res=30464288")
KLog.d("WebView progress: 25%")
KLog.d("WebView progress: 50%")
KLog.d("WebView progress: 75%")
KLog.d("WebView finish: https://gaia.komica1.org/79/pixmicat.php?res=30464288")
KLog.d("Check #0: {\"s\":\"CHALLENGE\",\"t\":\"checkbox\"}")
KLog.d("Challenge detected: checkbox")
KLog.d("Attempting auto-click...")
KLog.d("Click result: {\"c\":true}")
KLog.d("Checkbox clicked")
Toast: 請勾選下方驗證方塊
KLog.d("Check #1: {\"s\":\"CHALLENGE\"}")
KLog.d("Check #2: {\"s\":\"FORM\"}")
KLog.d("Injecting reply...")
KLog.d("Inject result: {\"f\":true}")
KLog.d("Check result URL: https://gaia.komica1.org/79/pixmicat.php?res=30464288")
KLog.d("Reply SUCCESS!")
```

---

## 六、測試步驟

### 6.1 收集完整日誌

```bash
adb logcat -c
adb logcat | grep -E "KLog|WebView|Turnstile" > komica_reply_test.txt
```

### 6.2 測試流程

1. 打開 App → 進入討論串
2. 點擊回覆按鈕 → 輸入內容 → 送出
3. 觀察：
   - [ ] 對話框開啟
   - [ ] WebView 載入進度顯示
   - [ ] 檢測到 Cloudflare
   - [ ] 自動點擊 checkbox (或提示)
   - [ ] 驗證完成後填寫表單
   - [ ] 提交成功顯示

---

## 七、總結

### 7.1 核心問題

V4.0 版本的 **三個致命問題**:

1. ❌ **未自動點擊 checkbox** - 只顯示等待
2. ❌ **無監控迴圈** - 無法檢測驗證完成
3. ❌ **無超時處理** - 可能永遠等待

### 7.2 解決方案

使用提供的修復版程式碼，實現：

- ✅ 自動點擊 Cloudflare checkbox
- ✅ 提交狀態監控 (Handler)
- ✅ 120 秒超時處理
- ✅ 網路錯誤檢測
- ✅ 完整日誌追蹤

---

*報告生成工具: opencode*  
*最後更新: 2026-01-08*
